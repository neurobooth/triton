Bootstrap: library
From: ubuntu:22.04

%help
	This Singularity definitions defines a container that runs a PyTriton inference server. The guest OS is Ubuntu 22.04, as that is what PyTriton is most rigourously tested on.

%post -c /bin/bash
	apt-get update && apt-get install -y --no-install-recommends --fix-missing software-properties-common

    # Add repository with various Python versions
	add-apt-repository ppa:deadsnakes/ppa -y

	# Install Python 3.10 and required build tools
	apt-get install -y --no-install-recommends --fix-missing \
	python3.10 \
	libpython3.10 \
	python3.10-distutils \
	python3-pip \
	build-essential \
	zlib1g-dev \
	libncurses5-dev \
	libgdbm-dev \
	libnss3-dev \
	libssl-dev \
	libsqlite3-dev \
	libreadline-dev \
	libffi-dev \
	curl \
	libbz2-dev \
	pkg-config \
	make \
    rsync \
    unzip \
    && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

    # Install PyTriton, PyTorch, NumPy, etc...
    python3.10 -m pip --no-cache-dir install \
    numpy \
    scipy>=1.10 \
    pandas \
    torch>=2.1 \
    torchvision \
    torchaudio \
    nvidia-pytriton \
    lightning \
    torchmetrics \
    pydantic>=2.0 \
    pyyaml \
    tqdm

%startscript
    # commands to be executed when the container runs as a service
    echo "Starting inference server..."
    exit 0  # Currently just a test!

%test
	python3.10 --version
    python3.10 -c "import torch; print(torch.__version__)"
    python3.10 -c "import pytriton"
